#!/usr/bin/env bash

set -euo pipefail

unset bump

while getopts "Mmp" opt; do
    case $opt in
    M) bump='major' ;;
    m) bump='minor' ;;
    p) bump='patch' ;;
    *) exit 2 ;;
    esac
done
shift $((OPTIND - 1))

if [[ -v bump ]]; then
    uv version --bump "$bump"
    git add pyproject.toml uv.lock
fi

version=$(uv version --short)
printf "%s\n" "$version"

if [[ -v bump ]]; then
    sed -i "/^__version__[[:space:]]=/s/=.*/= \"$version\"/" ./src/*/__init__.py
    git add ./src/*/__init__.py
    git commit -m "Bump $bump version"
    git tag "v$version"
fi

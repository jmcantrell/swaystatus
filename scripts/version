#!/usr/bin/env bash

set -euo pipefail

unset bump

while getopts "Mmp" opt; do
    case $opt in
    M) bump='major' ;;
    m) bump='minor' ;;
    p) bump='patch' ;;
    *) exit 2 ;;
    esac
done
shift $((OPTIND - 1))

read -r name version < <(uv version)

if [[ ! -v bump ]]; then
    printf "%s\n" "$version"
    exit
fi

uv version --bump "$bump"

version=$(uv version --short)
package_file=./src/$name/__init__.py
sed -i "/^__version__\b/s/=.*/= \"$version\"/" "$package_file"

git add "$package_file" uv.lock pyproject.toml
git commit -m "Bump $bump version"
git tag -a -m "Release version $version" v"$version"
